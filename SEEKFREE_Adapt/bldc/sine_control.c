#include "sine_control.h"
#include "bldc_config.h"
#include "common.h"

#pragma warning disable = 183

//三相电流的相位
int16 motor_a_position = 0;
int16 motor_b_position = 0;
int16 motor_c_position = 0;

// 峰值1024
// 一共360个点
uint16 sine_pwm_arr[] = 
{  
	514,523,532,541,549,558,567,576,585,594,603,611,620,629,638,646,
	655,663,672,680,689,697,705,714,722,730,738,746,754,762,769,777,
	785,792,800,807,814,821,828,835,842,849,856,862,869,875,881,887,
	893,899,905,911,916,922,927,932,937,942,947,952,956,960,965,969,
	973,976,980,984,987,990,993,996,999,1002,1004,1007,1009,1011,1013,1015,
	1016,1018,1019,1020,1021,1022,1022,1023,1023,1023,1023,1023,1023,1023,1022,1021,
	1020,1019,1018,1017,1015,1014,1012,1010,1008,1005,1003,1000,998,995,992,989,
	985,982,978,975,971,967,963,958,954,949,945,940,935,930,924,919,
	914,908,902,896,890,884,878,872,866,859,852,846,839,832,825,818,
	811,803,796,788,781,773,766,758,750,742,734,726,718,709,701,693,
	685,676,668,659,650,642,633,624,616,607,598,589,581,572,563,554,
	545,536,527,518,509,500,491,482,474,465,456,447,438,429,420,412,
	403,394,385,377,368,360,351,343,334,326,318,309,301,293,285,277,
	269,261,254,246,238,231,223,216,209,202,195,188,181,174,167,161,
	154,148,142,136,130,124,118,112,107,101,96,91,86,81,76,71,
	67,63,58,54,50,47,43,39,36,33,30,27,24,21,19,16,
	14,12,10,8,7,5,4,3,2,1,1,0,0,0,0,0,
	0,0,1,2,3,4,5,6,8,9,11,13,15,18,20,23,
	25,28,31,34,38,41,45,48,52,56,60,65,69,74,78,83,
	88,93,99,104,109,115,121,127,133,139,145,151,157,164,171,177,
	184,191,198,205,212,220,227,235,242,250,257,265,273,281,289,297,
	305,314,322,330,338,347,355,364,373,381,390,399,407,416,425,434,
	442,451,460,469,478,487,496,505
};

//-------------------------------------------------------------------------------------------------------------------
//  @brief      正弦启动初始化
//  @param      void
//  @return     void
//  @since      v1.0
//  Sample usage:
//-------------------------------------------------------------------------------------------------------------------
void sine_init(void)
{
	// 设置位置
	motor_a_position = 0;
	motor_b_position = motor_a_position + 119;
	motor_c_position = motor_a_position + 239;
	
	// 开启PWM输出
	PWMA_CCER1 = 0xFF;		// 开启比较输出, 低电平有效
	PWMA_CCER2 = 0x0F;		// 开启比较输出, 低电平有效
	
	// 使能PWM所有通道
	PWMA_ENO = 0x3F;


}
	


//-------------------------------------------------------------------------------------------------------------------
//  @brief      正弦强拉
//  @param      void
//  @return     void
//  @since      v1.0
//  Sample usage:
//-------------------------------------------------------------------------------------------------------------------
void sine_start(uint8 duty)
{
	uint16 temp = 0;
	
	motor_a_position --;
	if (motor_a_position < 0)
	{
		motor_a_position = 359 ;
	}
	
	motor_b_position --;
	if (motor_b_position < 0)
	{
		motor_b_position = 359;
	}
	
	motor_c_position --;
	if (motor_c_position < 0)
	{
		motor_c_position = 359 ;
	}

//	temp = ((uint32)sine_pwm_arr[motor_a_position] * BLDC_MAX_DUTY * 3) / 32 / 1024;		// 32为占空比的最大值. 1024为sine_pwm的峰值
	temp = ((uint32)sine_pwm_arr[motor_a_position] * BLDC_MAX_DUTY * duty) >> 5 >> 10;
	
	PWMA_CCR2H = (temp >> 8) & 0xFF;
    PWMA_CCR2L = temp & 0xFF;
    
	temp = ((uint32)sine_pwm_arr[motor_b_position] * BLDC_MAX_DUTY * duty) >> 5 >> 10;
    PWMA_CCR3H = (temp >> 8) & 0xFF;
    PWMA_CCR3L = temp & 0xFF;
    
	temp = ((uint32)sine_pwm_arr[motor_c_position] * BLDC_MAX_DUTY * duty) >> 5 >> 10;
    PWMA_CCR4H = (temp >> 8) & 0xFF;
    PWMA_CCR4L = temp & 0xFF;
	
}